name: CI - Entrenamiento del modelo y despliegue (MLflow + API)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model (generate joblib)
        run: |
          python gen_artefacto.py

      - name: Upload model artifact (GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: rf_forward_model
          path: rf_forward_model.joblib

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESSS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload model to S3
        run: |
          aws s3 cp rf_forward_model.joblib s3://${{ secrets.S3_BUCKET }}/rf_forward_model.joblib

      - name: Deploy MLflow + API to EC2 via SSM (AL2023-compatible, wait + logs)
        id: deploy_all
        shell: bash
        run: |
          set -euo pipefail

          IID="${{ secrets.EC2_INSTANCE_ID }}"
          REGION="${{ secrets.AWS_REGION }}"
          BUCKET="${{ secrets.S3_BUCKET }}"
          GH_PAT="${{ secrets.PAT_GITHUB }}"

          CMD_ID=$(aws ssm send-command \
            --instance-ids "$IID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy MLflow (SQLite+S3) + Download model + Deploy API" \
            --query "Command.CommandId" \
            --output text \
            --region "$REGION" \
            --parameters "commands=[
              \"sudo bash -lc 'set -euo pipefail; \
                echo \\\"== OS info ==\\\"; cat /etc/os-release || true; \
                echo \\\"== Install base packages ==\\\"; \
                if command -v dnf >/dev/null 2>&1; then \
                  sudo dnf update -y || true; \
                  sudo dnf install -y git curl python3-pip python3-virtualenv || true; \
                  (sudo dnf install -y docker || sudo dnf install -y moby-engine); \
                elif command -v yum >/dev/null 2>&1; then \
                  sudo yum update -y || true; \
                  sudo yum install -y git curl python3-pip python3-virtualenv docker || true; \
                elif command -v apt-get >/dev/null 2>&1; then \
                  sudo apt-get update -y; \
                  sudo apt-get install -y git curl python3-venv python3-pip docker.io docker-compose-plugin; \
                fi; \
                echo \\\"== Enable/start docker ==\\\"; \
                sudo systemctl enable docker || true; \
                sudo systemctl start docker || true; \
                echo \\\"== Docker version ==\\\"; docker --version; \
                echo \\\"== Ensure docker compose v2 ==\\\"; \
                sudo mkdir -p /usr/local/lib/docker/cli-plugins; \
                if ! docker compose version >/dev/null 2>&1; then \
                  sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 \
                    -o /usr/local/lib/docker/cli-plugins/docker-compose; \
                  sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose; \
                fi; \
                docker compose version; \
                echo \\\"== Clone repo fresh ==\\\"; \
                sudo rm -rf /opt/mlops; \
                cd /opt; \
                sudo git clone https://${GH_PAT}@github.com/JoseMoran-ast/MLOps.git mlops; \
                echo \\\"== Deploy MLflow ==\\\"; \
                sudo mkdir -p /opt/mlflow; \
                sudo test -f /opt/mlops/infra/mlflow/docker-compose.yaml; \
                sudo cp /opt/mlops/infra/mlflow/docker-compose.yaml /opt/mlflow/docker-compose.yml; \
                sudo tee /opt/mlflow/.env >/dev/null <<EOF \
                AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESSS_KEY_ID }} \
                AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
                AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }} \
                S3_BUCKET=${{ secrets.S3_BUCKET }} \
                EOF \
                                ; \
                                sudo docker compose -f /opt/mlflow/docker-compose.yml up -d; \
                                sudo docker compose -f /opt/mlflow/docker-compose.yml ps; \
                                echo \\\"== Check MLflow local ==\\\"; \
                                curl -sS -I --max-time 10 http://127.0.0.1:5000/; \
                                echo \\\"== Download model to stable artifacts dir ==\\\"; \
                                sudo mkdir -p /opt/mlops_artifacts; \
                                sudo aws s3 cp s3://${BUCKET}/rf_forward_model.joblib /opt/mlops_artifacts/rf_forward_model.joblib; \
                                sudo ls -la /opt/mlops_artifacts; \
                                echo \\\"== Deploy API (systemd) ==\\\"; \
                                sudo bash -lc \\\"cd /opt/mlops && python3 -m venv venv\\\"; \
                                sudo bash -lc \\\"cd /opt/mlops && . venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt && pip install uvicorn\\\"; \
                                sudo bash -lc \\\"cat > /etc/systemd/system/mlops-api.service <<\\\\'EOF2\\\\' \
                [Unit] \
                Description=MLOps FastAPI Inference API \
                After=network.target \
                \
                [Service] \
                Type=simple \
                WorkingDirectory=/opt/mlops \
                Environment=MODEL_PATH=/opt/mlops_artifacts/rf_forward_model.joblib \
                ExecStart=/opt/mlops/venv/bin/uvicorn api_server:app --host 0.0.0.0 --port 8000 \
                Restart=always \
                RestartSec=3 \
                \
                [Install] \
                WantedBy=multi-user.target \
                EOF2 \
                \\\"; \
                                sudo systemctl daemon-reload; \
                                sudo systemctl enable mlops-api.service; \
                                sudo systemctl restart mlops-api.service; \
                                sudo systemctl status mlops-api.service --no-pager; \
                                echo \\\"== Ports ==\\\"; \
                                sudo ss -ltnp | egrep \\\":5000|:8000\\\" || true; \
                                echo \\\"== Docker ps ==\\\"; \
                                sudo docker ps --format \\\"table {{.Names}}\\t{{.Status}}\\t{{.Ports}}\\\"; \
                                echo \\\"== DONE ==\\\"; \
                              '\" \
                            ]")

                          echo "cmd_id=$CMD_ID" >> $GITHUB_OUTPUT
                          echo "SSM CommandId: $CMD_ID"

          STATUS="Pending"
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$CMD_ID" \
              --instance-id "$IID" \
              --query "Status" \
              --output text \
              --region "$REGION" || true)
            echo "[$i] Status: $STATUS"
            if [[ "$STATUS" == "Success" || "$STATUS" == "Failed" || "$STATUS" == "Cancelled" || "$STATUS" == "TimedOut" ]]; then
              break
            fi
            sleep 5
          done

          echo "----- STDOUT -----"
          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "$IID" \
            --query "StandardOutputContent" \
            --output text \
            --region "$REGION" || true

          echo "----- STDERR -----"
          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "$IID" \
            --query "StandardErrorContent" \
            --output text \
            --region "$REGION" || true

          if [[ "$STATUS" != "Success" ]]; then
            echo "Remote deploy failed with status: $STATUS"
            exit 1
          fi
